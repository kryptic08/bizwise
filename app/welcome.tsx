import AsyncStorage from "@react-native-async-storage/async-storage";
import { useRouter } from "expo-router";
import { useEffect, useState } from "react";
import { StatusBar, StyleSheet, View } from "react-native";
import Svg, { Path } from "react-native-svg";
import { useAuth } from "./context/AuthContext";

export default function WelcomeScreen() {
  const router = useRouter();
  const { user, isLoading } = useAuth();
  const [hasSeenOnboarding, setHasSeenOnboarding] = useState<boolean | null>(
    null,
  );

  useEffect(() => {
    const checkOnboarding = async () => {
      try {
        const value = await AsyncStorage.getItem("hasSeenOnboarding");
        setHasSeenOnboarding(value !== null);
      } catch (error) {
        console.error("Error checking onboarding:", error);
        setHasSeenOnboarding(false);
      }
    };

    checkOnboarding();
  }, []);

  useEffect(() => {
    if (isLoading || hasSeenOnboarding === null) return;

    // Show welcome screen for 2 seconds, then navigate based on state
    const timer = setTimeout(() => {
      if (user) {
        // User is logged in, go to main app
        router.replace("/(tabs)");
      } else if (hasSeenOnboarding) {
        // User has seen onboarding before, go to login
        router.replace("/login");
      } else {
        // First time user, show onboarding
        router.replace("/onboarding");
      }
    }, 2000);

    return () => clearTimeout(timer);
  }, [isLoading, user, hasSeenOnboarding, router]);

  return (
    <View style={styles.container}>
      <StatusBar barStyle="light-content" backgroundColor="#007AFF" />
      {/* Logo */}
      <Svg width="118" height="124" viewBox="0 0 118 124" fill="none">
        <Path
          d="M55.7656 119.109V66.3306H76.9707V119.109M20.2606 119.109V93.5042H41.4658V119.109M92.126 119.109V41.1125H113.331V119.109M4.33124 77.9212L49.6953 32.5571L65.1358 46.4699L106.242 5.38353M105.305 24.1647L107.2 7.01315C107.235 6.65221 107.189 6.28795 107.066 5.94678C106.943 5.60561 106.746 5.29607 106.489 5.04061C106.232 4.78515 105.921 4.59019 105.578 4.46982C105.236 4.34945 104.872 4.3067 104.511 4.34468L87.3797 6.23908"
          stroke="white"
          strokeWidth="8.6625"
          strokeLinecap="round"
          strokeLinejoin="round"
        />
      </Svg>

      {/* BizWise Text */}
      <View style={styles.textContainer}>
        <Svg width="197" height="42" viewBox="0 0 197 42" fill="none">
          <Path
            d="M20.6486 22.2129C22.6995 22.5952 24.3855 23.6207 25.7064 25.2893C27.0274 26.9579 27.6879 28.8698 27.6879 31.025C27.6879 32.9717 27.2012 34.6924 26.2279 36.1871C25.2893 37.6471 23.9162 38.7943 22.1086 39.6286C20.301 40.4629 18.1631 40.88 15.695 40.88H1.0682e-05V4.48429H15.0172C17.4853 4.48429 19.6057 4.88405 21.3786 5.68357C23.1862 6.4831 24.5419 7.59548 25.4457 9.02072C26.3843 10.446 26.8536 12.0624 26.8536 13.87C26.8536 15.9905 26.28 17.7633 25.1329 19.1886C24.0205 20.6138 22.5257 21.6219 20.6486 22.2129ZM7.30001 19.5014H13.9743C15.7124 19.5014 17.0507 19.1191 17.9893 18.3543C18.9279 17.5548 19.3972 16.425 19.3972 14.965C19.3972 13.505 18.9279 12.3752 17.9893 11.5757C17.0507 10.7762 15.7124 10.3764 13.9743 10.3764H7.30001V19.5014ZM14.6522 34.9357C16.425 34.9357 17.7981 34.5186 18.7714 33.6843C19.7795 32.85 20.2836 31.6681 20.2836 30.1386C20.2836 28.5743 19.7622 27.3576 18.7193 26.4886C17.6764 25.5848 16.2686 25.1329 14.4957 25.1329H7.30001V34.9357H14.6522ZM37.208 8.55143C35.9218 8.55143 34.8442 8.15167 33.9752 7.35215C33.1409 6.51786 32.7237 5.49238 32.7237 4.27572C32.7237 3.05905 33.1409 2.05095 33.9752 1.25143C34.8442 0.417143 35.9218 2.80516e-07 37.208 2.80516e-07C38.4942 2.80516e-07 39.5544 0.417143 40.3887 1.25143C41.2578 2.05095 41.6923 3.05905 41.6923 4.27572C41.6923 5.49238 41.2578 6.51786 40.3887 7.35215C39.5544 8.15167 38.4942 8.55143 37.208 8.55143ZM40.8059 11.9929V40.88H33.5059V11.9929H40.8059ZM54.6926 34.8836H67.5719V40.88H46.4019V34.9879L59.0204 17.9893H46.454V11.9929H67.4154V17.885L54.6926 34.8836ZM121.873 4.48429L111.706 40.88H103.102L96.2712 14.965L89.1276 40.88L80.5762 40.9321L70.7734 4.48429H78.5948L85.0084 32.7457L92.4126 4.48429H100.547L107.534 32.5893L114 4.48429H121.873ZM130.342 8.55143C129.056 8.55143 127.978 8.15167 127.109 7.35215C126.275 6.51786 125.858 5.49238 125.858 4.27572C125.858 3.05905 126.275 2.05095 127.109 1.25143C127.978 0.417143 129.056 2.80516e-07 130.342 2.80516e-07C131.628 2.80516e-07 132.689 0.417143 133.523 1.25143C134.392 2.05095 134.826 3.05905 134.826 4.27572C134.826 5.49238 134.392 6.51786 133.523 7.35215C132.689 8.15167 131.628 8.55143 130.342 8.55143ZM133.94 11.9929V40.88H126.64V11.9929H133.94ZM152.207 41.3493C149.843 41.3493 147.722 40.9321 145.845 40.0979C143.968 39.2288 142.473 38.0643 141.361 36.6043C140.283 35.1443 139.692 33.5279 139.588 31.755H146.94C147.079 32.8674 147.618 33.7886 148.557 34.5186C149.53 35.2486 150.729 35.6136 152.155 35.6136C153.545 35.6136 154.623 35.3355 155.387 34.7793C156.187 34.2231 156.587 33.5105 156.587 32.6414C156.587 31.7029 156.1 31.0076 155.127 30.5557C154.188 30.0691 152.676 29.5476 150.59 28.9914C148.435 28.47 146.662 27.9312 145.272 27.375C143.916 26.8188 142.734 25.9671 141.726 24.82C140.753 23.6729 140.266 22.126 140.266 20.1793C140.266 18.5802 140.718 17.1202 141.622 15.7993C142.56 14.4783 143.881 13.4355 145.585 12.6707C147.323 11.906 149.356 11.5236 151.685 11.5236C155.127 11.5236 157.873 12.3926 159.924 14.1307C161.975 15.8341 163.105 18.1457 163.313 21.0657H156.326C156.222 19.9186 155.735 19.0148 154.866 18.3543C154.032 17.6591 152.902 17.3114 151.477 17.3114C150.156 17.3114 149.13 17.5548 148.4 18.0414C147.705 18.5281 147.357 19.206 147.357 20.075C147.357 21.0483 147.844 21.7957 148.817 22.3171C149.791 22.8038 151.303 23.3079 153.354 23.8293C155.44 24.3507 157.16 24.8895 158.516 25.4457C159.872 26.0019 161.036 26.871 162.01 28.0529C163.018 29.2 163.539 30.7295 163.574 32.6414C163.574 34.31 163.105 35.8048 162.166 37.1257C161.262 38.4467 159.941 39.4895 158.203 40.2543C156.5 40.9843 154.501 41.3493 152.207 41.3493ZM196.42 25.8107C196.42 26.8536 196.35 27.7921 196.211 28.6264H175.093C175.267 30.7121 175.997 32.346 177.283 33.5279C178.569 34.7098 180.151 35.3007 182.028 35.3007C184.74 35.3007 186.669 34.1362 187.816 31.8071H195.69C194.855 34.5881 193.256 36.8824 190.893 38.69C188.529 40.4629 185.626 41.3493 182.185 41.3493C179.404 41.3493 176.901 40.741 174.676 39.5243C172.486 38.2729 170.765 36.5174 169.514 34.2579C168.297 31.9983 167.689 29.3912 167.689 26.4364C167.689 23.4469 168.297 20.8224 169.514 18.5629C170.731 16.3033 172.434 14.5652 174.624 13.3486C176.814 12.1319 179.334 11.5236 182.185 11.5236C184.931 11.5236 187.382 12.1145 189.537 13.2964C191.727 14.4783 193.413 16.1643 194.595 18.3543C195.811 20.5095 196.42 22.995 196.42 25.8107ZM188.859 23.725C188.824 21.8479 188.146 20.3531 186.825 19.2407C185.504 18.0936 183.888 17.52 181.976 17.52C180.169 17.52 178.639 18.0762 177.388 19.1886C176.171 20.2662 175.424 21.7783 175.145 23.725H188.859Z"
            fill="white"
          />
        </Svg>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "#007AFF",
    justifyContent: "center",
    alignItems: "center",
    gap: 24,
  },
  textContainer: {
    marginTop: 16,
  },
});
